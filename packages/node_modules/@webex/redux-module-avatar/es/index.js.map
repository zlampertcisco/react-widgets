{"version":3,"file":"index.js","sources":["../src/actions.js","../src/reducer.js"],"sourcesContent":["import {bufferToBlob} from '@webex/react-component-utils';\n\nexport const ADD_AVATAR = 'avatar/ADD_AVATAR';\nexport const ADD_AVATAR_BEGIN = 'avatar/ADD_AVATAR_BEGIN';\n\n\nexport function addAvatar(id, avatar) {\n  return {\n    type: ADD_AVATAR,\n    payload: {\n      id,\n      avatar\n    }\n  };\n}\n\nfunction addAvatarBegin(id) {\n  return {\n    type: ADD_AVATAR_BEGIN,\n    payload: {\n      id\n    }\n  };\n}\n\n/**\n * A bit of a hack to get smaller Avatars from Public API\n */\n\nexport function convertToSmallAvatar(avatarUrl) {\n  const sizeRegEx = /~\\d+$/;\n\n  if (sizeRegEx.test(avatarUrl)) {\n    return avatarUrl.replace(sizeRegEx, '~110');\n  }\n\n  return avatarUrl;\n}\n\n\nfunction fetchUserAvatar(userId, spark) {\n  return (dispatch) => {\n    dispatch(addAvatarBegin(userId));\n\n    return spark.people.get(userId)\n      .then((person) => {\n        const avatar = convertToSmallAvatar(person.avatar);\n\n        dispatch(addAvatar(userId, avatar));\n\n        return Promise.resolve(avatar);\n      })\n      .catch(() => {\n        dispatch(addAvatar(userId, ''));\n\n        return Promise.resolve({id: userId});\n      });\n  };\n}\n\nfunction fetchSpaceAvatar(space, sparkInstance, userIdForAvatar) {\n  return (dispatch) => {\n    if (space.type === 'direct' && space.participants.length === 2) {\n      if (!userIdForAvatar) {\n        return Promise.reject(new Error('Direct spaces require a user id to display'));\n      }\n\n      return dispatch(fetchUserAvatar(userIdForAvatar, sparkInstance));\n    }\n    if (space.avatar) {\n      dispatch(addAvatarBegin(space.id));\n\n      return sparkInstance.internal.conversation.download(space.avatar.files.items[0])\n        .then((file) => {\n          const {objectUrl} = bufferToBlob(file);\n\n          dispatch(addAvatar(space.id, objectUrl));\n\n          return Promise.resolve({id: space.id});\n        });\n    }\n    dispatch(addAvatar(space.id, ''));\n\n    return Promise.resolve({id: space.id});\n  };\n}\n\n/**\n * Fetches an avatar for a given space or user id\n * @param {Object} params\n * @param {Object} params.space\n * @param {String} params.userId\n * @param {Object} spark\n * @returns {Thunk}\n */\nexport function fetchAvatar({space, userId}, spark) {\n  return (dispatch, getState) => {\n    const {avatar} = getState();\n    const avatarId = space ? space.id : userId;\n    const hasFetched = avatar.hasIn(['items', avatarId]);\n    const isFetching = avatar.hasIn(['avatarsInFlight', avatarId]);\n\n    if (hasFetched) {\n      return Promise.resolve(avatar.getIn(['items', avatarId]));\n    }\n\n    if (isFetching) {\n      return Promise.resolve();\n    }\n\n    if (space) {\n      return dispatch(fetchSpaceAvatar(space, spark, userId));\n    }\n\n    return dispatch(fetchUserAvatar(userId, spark));\n  };\n}\n\n\n/**\n * Fetches a group of users' avatars\n * @param {Array} userIds\n * @param {object} spark\n * @returns {Thunk}\n */\nexport function fetchAvatarsForUsers(userIds, spark) {\n  return (dispatch) => Promise.all(userIds.map((userId) => dispatch(fetchAvatar({userId}, spark))));\n}\n","import {fromJS} from 'immutable';\n\nimport {ADD_AVATAR, ADD_AVATAR_BEGIN} from './actions';\n\nexport const initialState = fromJS({\n  items: {},\n  avatarsInFlight: {}\n});\n\nexport default function reducer(state = initialState, action) {\n  switch (action.type) {\n    case ADD_AVATAR:\n    {\n      const {id, avatar} = action.payload;\n\n      return state.setIn(['items', id], avatar).deleteIn(['avatarsInFlight', id]);\n    }\n    case ADD_AVATAR_BEGIN:\n      return state.setIn(['avatarsInFlight', action.payload.id], true);\n    default:\n      return state;\n  }\n}\n"],"names":["ADD_AVATAR","ADD_AVATAR_BEGIN","addAvatar","id","avatar","type","payload","addAvatarBegin","convertToSmallAvatar","avatarUrl","sizeRegEx","test","replace","fetchUserAvatar","userId","spark","dispatch","people","get","then","person","Promise","resolve","catch","fetchSpaceAvatar","space","sparkInstance","userIdForAvatar","participants","length","reject","Error","internal","conversation","download","files","items","file","objectUrl","bufferToBlob","fetchAvatar","getState","avatarId","hasFetched","hasIn","isFetching","getIn","fetchAvatarsForUsers","userIds","all","map","initialState","fromJS","avatarsInFlight","reducer","state","action","setIn","deleteIn"],"mappings":"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"}